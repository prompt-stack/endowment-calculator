{# 
  @template templates/report_preview.html
  @type page
  @htmx true
#}
{% extends "base.html" %}

{% block content %}
    
<style>
        /* Clean layout matching calculator aesthetic */
        .preview-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-xl);
        }
        
        .preview-header {
            text-align: center;
            margin-bottom: var(--space-2xl);
            padding: var(--space-2xl) 0;
            background: var(--surface-muted);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color-light);
        }
        
        .preview-header h1 {
            color: var(--color-primary);
            margin-bottom: var(--space-md);
            font-size: 2rem;
            font-weight: 600;
        }
        
        .preview-header p {
            color: var(--color-gray-600);
            font-size: 1.125rem;
        }
        
        .preview-badge {
            background: var(--color-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: var(--space-md);
        }
        
        .report-sample {
            background: var(--surface-primary);
            border: 1px solid var(--border-color-light);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin: var(--space-xl) 0;
        }
        
        .report-page {
            padding: 2rem;
            border-bottom: 1px solid var(--color-gray-200);
        }
        
        .report-page:last-child {
            border-bottom: none;
        }
        
        .page-label {
            background: var(--color-gray-100);
            color: var(--color-gray-600);
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .lead-capture-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .lead-capture-overlay.active {
            overflow: hidden;
        }
        
        body.modal-open {
            overflow: hidden;
        }
        
        .lead-capture-modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .blur-content {
            filter: blur(3px);
            pointer-events: none;
        }
        
        .value-proposition {
            background: var(--color-gray-50);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        
        .chart-placeholder {
            background: var(--color-gray-100);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            color: var(--color-gray-600);
            margin: 1rem 0;
        }
</style>

    <div class="preview-container">
        <div class="preview-header">
            <div class="preview-badge">WEB REPORT VERSION</div>
            <h1>Endowment Sustainability Report</h1>
            <p>Professional web version • Shareable with clients • Exportable to PDF</p>
            
            <div style="margin-top: var(--space-lg); display: flex; justify-content: center; gap: var(--space-lg); font-size: 0.8125rem; color: var(--color-gray-600);">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-link" style="margin-right: 0.5rem; color: var(--color-primary);"></i>
                    Share via URL
                </div>
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-file-pdf" style="margin-right: 0.5rem; color: var(--color-primary);"></i>
                    Export to PDF
                </div>
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-envelope" style="margin-right: 0.5rem; color: var(--color-primary);"></i>
                    Email delivery
                </div>
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-chart-bar" style="margin-right: 0.5rem; color: var(--color-primary);"></i>
                    Lead generation
                </div>
            </div>
        </div>
        <!-- Web Report Features -->
        <div class="value-proposition">
            <h3 style="margin: 0 0 1rem 0; color: var(--color-primary);">Professional Web Report Features</h3>
            <p style="margin: 0 0 1.5rem 0; font-size: 0.9375rem; color: var(--color-gray-600);">
                This web version can be shared with clients via URL, exported to PDF, or used for lead generation workflows.
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                    <strong>✓ Executive Summary</strong><br>
                    <span style="font-size: 0.875rem; color: var(--color-gray-600);">Clear recommendations and key findings</span>
                </div>
                <div>
                    <strong>✓ Interactive Charts</strong><br>
                    <span style="font-size: 0.875rem; color: var(--color-gray-600);">Detailed projection visualizations</span>
                </div>
                <div>
                    <strong>✓ Risk Analysis</strong><br>
                    <span style="font-size: 0.875rem; color: var(--color-gray-600);">Monte Carlo scenario modeling</span>
                </div>
                <div>
                    <strong>✓ Next Steps</strong><br>
                    <span style="font-size: 0.875rem; color: var(--color-gray-600);">Actionable implementation guidance</span>
                </div>
            </div>
        </div>

        <!-- Report Sample -->
        <div class="report-sample">
            <!-- Page 1 Preview -->
            <div class="page-label">Page 1: Executive Summary</div>
            <div class="report-page">
                <h2 style="color: var(--color-primary); margin: 0 0 1rem 0;">Endowment Sustainability Analysis</h2>
                <p style="color: var(--color-gray-600); margin-bottom: 1.5rem;">Generated on {{ current_date }}</p>
                
                <div style="background: var(--color-gray-50); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--color-primary);">Executive Summary</h4>
                    <p style="margin-bottom: 1rem;">Our Monte Carlo analysis of your <strong>${{ "{:,.0f}".format(results.balance) }} endowment</strong> reveals critical insights for long-term sustainability. With planned annual withdrawals of <strong>${{ "{:,.0f}".format(results.calculation_details.annual_withdrawal) }} ({{ "{:.1f}".format(results.calculation_details.withdrawal_rate_percent) }}%)</strong>, your organization faces important strategic decisions.</p>
                    
                    <div style="background: rgba(43, 108, 176, 0.1); padding: 1rem; border-radius: 6px; margin: 1rem 0; border-left: 4px solid var(--color-accent);">
                        <strong style="color: var(--color-accent);">Key Finding:</strong> The Balanced (70/30) portfolio offers the optimal risk-adjusted sustainability at 53.8% success rate, significantly outperforming conservative approaches while maintaining reasonable risk levels.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                        {% for key, portfolio_data in results.portfolios.items() %}
                        <div style="text-align: center; background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.75rem; color: var(--color-gray-600); margin-bottom: 0.5rem; font-weight: 600;">{{ portfolio_data.portfolio.name }}</div>
                            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem; color: {% if portfolio_data.success_rate >= 0.7 %}var(--color-success){% elif portfolio_data.success_rate >= 0.5 %}var(--color-warning){% else %}var(--color-danger){% endif %};">
                                {{ "{:.1f}".format(portfolio_data.success_rate * 100) }}%
                            </div>
                            <div style="font-size: 0.625rem; color: var(--color-gray-500); text-transform: uppercase; letter-spacing: 0.5px;">Success Rate</div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 6px;">
                        <h5 style="margin: 0 0 0.5rem 0; color: var(--color-primary);">Strategic Recommendations</h5>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.875rem;">
                            <div>
                                <strong style="color: var(--color-success);">✓ Immediate Actions:</strong><br>
                                <span style="color: var(--color-gray-600);">Implement balanced portfolio allocation</span>
                            </div>
                            <div>
                                <strong style="color: var(--color-warning);">⚠ Risk Mitigation:</strong><br>
                                <span style="color: var(--color-gray-600);">Establish spending policy reserve</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="height: 250px; margin: 1rem 0;">
                    <canvas id="successRateChart"></canvas>
                </div>
            </div>

            <!-- Page 2 Preview -->
            <div class="page-label">Page 2: Portfolio Analysis</div>
            <div class="report-page">
                <h3 style="margin: 0 0 1rem 0;">Individual Portfolio Analysis</h3>
                
                {% for key, portfolio_data in results.portfolios.items() %}
                <div style="border: 1px solid var(--color-gray-200); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: var(--color-primary);">{{ portfolio_data.portfolio.name }} Strategy</h4>
                        <div style="background: {% if portfolio_data.success_rate >= 0.7 %}var(--color-success){% elif portfolio_data.success_rate >= 0.5 %}var(--color-warning){% else %}var(--color-danger){% endif %}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                            {{ "{:.1f}".format(portfolio_data.success_rate * 100) }}% Success
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div style="text-align: center; background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--color-gray-100);">
                            <div style="font-size: 0.75rem; color: var(--color-gray-500); margin-bottom: 0.25rem;">Expected Return</div>
                            <div style="font-size: 1.125rem; font-weight: bold; color: var(--color-primary);">{{ "{:.1f}".format(portfolio_data.portfolio.expected_return * 100) }}%</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--color-gray-100);">
                            <div style="font-size: 0.75rem; color: var(--color-gray-500); margin-bottom: 0.25rem;">Risk Level</div>
                            <div style="font-size: 1.125rem; font-weight: bold; color: var(--color-accent);">{{ "{:.1f}".format(portfolio_data.portfolio.std_deviation * 100) }}%</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--color-gray-100);">
                            <div style="font-size: 0.75rem; color: var(--color-gray-500); margin-bottom: 0.25rem;">50-Year Median</div>
                            <div style="font-size: 1.125rem; font-weight: bold; color: var(--color-success);">${{ "{:,.1f}".format(portfolio_data.median_final_balance / 1000000) }}M</div>
                        </div>
                    </div>
                    
                    {% if key == 'balanced' %}
                    <div style="background: var(--surface-muted); padding: var(--space-lg); border-radius: var(--border-radius); margin-bottom: var(--space-md); border-left: 3px solid var(--color-primary);">
                        <strong style="color: var(--color-primary);">Recommended Strategy:</strong> <span style="color: var(--color-gray-700);">This balanced approach offers optimal risk-adjusted returns for most nonprofits, providing growth potential while managing downside risk.</span>
                    </div>
                    {% elif key == 'conservative' %}
                    <div style="background: var(--surface-muted); padding: var(--space-lg); border-radius: var(--border-radius); margin-bottom: var(--space-md); border-left: 3px solid var(--color-gray-500);">
                        <strong style="color: var(--color-gray-700);">Conservative Approach:</strong> <span style="color: var(--color-gray-600);">Lower risk allocation may face challenges maintaining purchasing power over time with higher withdrawal rates.</span>
                    </div>
                    {% else %}
                    <div style="background: var(--surface-muted); padding: var(--space-lg); border-radius: var(--border-radius); margin-bottom: var(--space-md); border-left: 3px solid var(--color-gray-500);">
                        <strong style="color: var(--color-gray-700);">Growth Strategy:</strong> <span style="color: var(--color-gray-600);">Higher return potential requires comfort with increased volatility and potential drawdowns.</span>
                    </div>
                    {% endif %}
                    
                    <div style="height: 200px; margin: 1rem 0;">
                        <canvas id="portfolio-{{ key }}-chart"></canvas>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Page 3 Preview -->
            <div class="page-label">Page 3: Risk Analysis & Implementation Guide</div>
            <div class="report-page">
                <h3 style="margin: 0 0 1.5rem 0; color: var(--color-primary);">Risk Analysis & Strategic Implementation</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--color-gray-50); padding: 1.5rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--color-primary);">Monte Carlo Methodology</h4>
                        <div style="font-size: 0.875rem; line-height: 1.6;">
                            <p style="margin: 0 0 0.75rem 0;"><strong>5,000 simulations</strong> model market volatility and portfolio performance over {{ results.years }} years.</p>
                            <div style="background: white; padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0;">
                                <strong>Key Assumptions:</strong><br>
                                • {{ "{:.1f}".format(results.inflation_rate * 100) }}% average inflation<br>
                                • Normal return distributions<br>
                                • Annual rebalancing
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--color-gray-50); padding: 1.5rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--color-primary);">Scenario Analysis</h4>
                        <div style="font-size: 0.875rem; line-height: 1.6;">
                            <div style="background: rgba(197, 48, 48, 0.1); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid var(--color-danger);">
                                <strong>Bear Market Resilience:</strong> Analysis includes 2008-style market crashes and prolonged downturns.
                            </div>
                            <div style="background: rgba(5, 150, 105, 0.1); padding: 0.75rem; border-radius: 6px; border-left: 3px solid var(--color-success);">
                                <strong>Bull Market Potential:</strong> Captures upside scenarios with sustained growth periods.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--color-gray-200);">
                    <h4 style="margin: 0 0 1rem 0; color: var(--color-primary);">Strategic Implementation Roadmap</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div style="background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="background: var(--color-success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.75rem; display: inline-block;">Phase 1: 0-3 Months</div>
                            <h5 style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">Foundation</h5>
                            <ul style="margin: 0; padding-left: 1rem; font-size: 0.8125rem; color: var(--color-gray-600);">
                                <li>Investment policy review</li>
                                <li>Asset allocation transition</li>
                                <li>Board education sessions</li>
                            </ul>
                        </div>
                        
                        <div style="background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="background: var(--color-warning); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.75rem; display: inline-block;">Phase 2: 3-6 Months</div>
                            <h5 style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">Implementation</h5>
                            <ul style="margin: 0; padding-left: 1rem; font-size: 0.8125rem; color: var(--color-gray-600);">
                                <li>Portfolio rebalancing</li>
                                <li>Spending policy updates</li>
                                <li>Risk monitoring setup</li>
                            </ul>
                        </div>
                        
                        <div style="background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="background: var(--color-primary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.75rem; display: inline-block;">Phase 3: Ongoing</div>
                            <h5 style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">Monitoring</h5>
                            <ul style="margin: 0; padding-left: 1rem; font-size: 0.8125rem; color: var(--color-gray-600);">
                                <li>Quarterly performance review</li>
                                <li>Annual strategy assessment</li>
                                <li>Board reporting dashboard</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(43, 108, 176, 0.05); padding: 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: 1px solid rgba(43, 108, 176, 0.2);">
                    <h4 style="margin: 0 0 1rem 0; color: var(--color-accent);">Board Presentation Package Included</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.875rem;">
                        <div>
                            <strong>✓ Executive summary slides</strong><br>
                            <span style="color: var(--color-gray-600);">Key findings and recommendations</span>
                        </div>
                        <div>
                            <strong>✓ Detailed appendix</strong><br>
                            <span style="color: var(--color-gray-600);">Technical methodology and assumptions</span>
                        </div>
                        <div>
                            <strong>✓ Risk scenarios</strong><br>
                            <span style="color: var(--color-gray-600);">Stress testing and sensitivity analysis</span>
                        </div>
                        <div>
                            <strong>✓ Implementation timeline</strong><br>
                            <span style="color: var(--color-gray-600);">Step-by-step transition plan</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Professional Export Features -->
        <div style="background: var(--surface-muted); border: 1px solid var(--border-color-light); padding: var(--space-2xl); border-radius: var(--border-radius); margin: var(--space-xl) 0;">
            <h3 style="margin: 0 0 var(--space-lg) 0; color: var(--color-primary); text-align: center; font-weight: 600;">Professional Export Features</h3>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-lg);">
                <div style="background: var(--surface-primary); border: 1px solid var(--border-color-light); padding: var(--space-lg); border-radius: var(--border-radius); text-align: center;">
                    <div style="color: var(--color-primary); margin-bottom: var(--space-md);"><i class="fas fa-chart-line" style="font-size: 1.5rem;"></i></div>
                    <h4 style="margin: 0 0 var(--space-sm) 0; color: var(--color-primary); font-size: 1rem; font-weight: 600;">Interactive PDF</h4>
                    <p style="margin: 0; font-size: 0.875rem; color: var(--color-gray-600); line-height: 1.5;">Professional Letter-size report with embedded charts and navigation</p>
                </div>
                
                <div style="background: var(--surface-primary); border: 1px solid var(--border-color-light); padding: var(--space-lg); border-radius: var(--border-radius); text-align: center;">
                    <div style="color: var(--color-primary); margin-bottom: var(--space-md);"><i class="fas fa-presentation" style="font-size: 1.5rem;"></i></div>
                    <h4 style="margin: 0 0 var(--space-sm) 0; color: var(--color-primary); font-size: 1rem; font-weight: 600;">Board-Ready</h4>
                    <p style="margin: 0; font-size: 0.875rem; color: var(--color-gray-600); line-height: 1.5;">Executive slides and appendix optimized for presentations</p>
                </div>
                
                <div style="background: var(--surface-primary); border: 1px solid var(--border-color-light); padding: var(--space-lg); border-radius: var(--border-radius); text-align: center;">
                    <div style="color: var(--color-primary); margin-bottom: var(--space-md);"><i class="fas fa-download" style="font-size: 1.5rem;"></i></div>
                    <h4 style="margin: 0 0 var(--space-sm) 0; color: var(--color-primary); font-size: 1rem; font-weight: 600;">Instant Access</h4>
                    <p style="margin: 0; font-size: 0.875rem; color: var(--color-gray-600); line-height: 1.5;">Immediate generation with organization-specific data</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: var(--space-xl);">
                <button onclick="showAdvisorConsultation()" class="btn btn-primary" style="padding: var(--space-lg) var(--space-2xl); font-size: 1rem;">
                    <i class="fas fa-calendar-check" style="margin-right: 0.5rem;"></i>Schedule Consultation
                </button>
            </div>
        </div>
        
        <!-- White-Label Customization -->
        <div style="background: var(--surface-muted); border: 1px solid var(--border-color-light); padding: var(--space-2xl); border-radius: var(--border-radius); margin: var(--space-xl) 0;">
            <div style="text-align: center; margin-bottom: var(--space-lg);">
                <h4 style="margin: 0 0 var(--space-sm) 0; color: var(--color-primary); font-weight: 600;">White-Label Customization</h4>
                <p style="margin: 0; font-size: 0.875rem; color: var(--color-gray-600);">Fully customizable with your firm's branding and analysis preferences</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <i class="fas fa-paint-brush" style="color: var(--color-primary); margin-bottom: 0.5rem;"></i>
                    <strong style="display: block; font-size: 0.875rem; color: var(--color-primary);">Custom Branding</strong>
                    <span style="font-size: 0.75rem; color: var(--color-gray-600);">Logo, colors, fonts</span>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <i class="fas fa-chart-bar" style="color: var(--color-accent); margin-bottom: 0.5rem;"></i>
                    <strong style="display: block; font-size: 0.875rem; color: var(--color-accent);">Analysis Depth</strong>
                    <span style="font-size: 0.75rem; color: var(--color-gray-600);">Adjustable complexity</span>
                </div>
                <div style="background: white; padding: 1rem; border-radius: 6px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <i class="fas fa-users" style="color: var(--color-success); margin-bottom: 0.5rem;"></i>
                    <strong style="display: block; font-size: 0.875rem; color: var(--color-success);">Client Focus</strong>
                    <span style="font-size: 0.75rem; color: var(--color-gray-600);">Nonprofit-specific insights</span>
                </div>
            </div>
            
            <div style="background: rgba(43, 108, 176, 0.1); padding: 1rem; border-radius: 6px; border-left: 4px solid var(--color-accent);">
                <strong style="color: var(--color-accent); font-size: 0.875rem;">For Financial Advisors:</strong>
                <span style="color: var(--color-gray-700); font-size: 0.875rem;"> This platform can be configured to match your firm's investment philosophy, risk assessment methodology, and client communication style.</span>
            </div>
            
            <!-- Interactive Demo Section -->
            <div style="margin-top: var(--space-lg); padding: var(--space-lg); background: var(--surface-primary); border-radius: var(--border-radius); border: 1px solid var(--border-color-light);">
                <h5 style="margin: 0 0 var(--space-md) 0; color: var(--color-primary); font-size: 0.875rem; font-weight: 600;">
                    <i class="fas fa-mouse-pointer" style="margin-right: 0.5rem;"></i>Try Interactive Demo
                </h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                    <div onclick="simulateDownload()" style="border: 1px solid var(--border-color-light); border-radius: var(--border-radius); padding: var(--space-lg); cursor: pointer; transition: all 0.2s ease; background: var(--surface-primary);" onmouseover="this.style.borderColor='var(--color-primary)'; this.style.background='var(--surface-muted)'" onmouseout="this.style.borderColor='var(--border-color-light)'; this.style.background='var(--surface-primary)'">
                        <div style="display: flex; align-items: center; margin-bottom: var(--space-sm);">
                            <i class="fas fa-download" style="color: var(--color-primary); margin-right: var(--space-sm); font-size: 1.125rem;"></i>
                            <strong style="color: var(--color-primary); font-size: 0.875rem;">Instant Download</strong>
                        </div>
                        <p style="margin: 0; font-size: 0.8125rem; color: var(--color-gray-600); line-height: 1.4;">
                            Experience immediate PDF access workflow
                        </p>
                    </div>
                    
                    <div onclick="simulateConsultation()" style="border: 1px solid var(--border-color-light); border-radius: var(--border-radius); padding: var(--space-lg); cursor: pointer; transition: all 0.2s ease; background: var(--surface-primary);" onmouseover="this.style.borderColor='var(--color-primary)'; this.style.background='var(--surface-muted)'" onmouseout="this.style.borderColor='var(--border-color-light)'; this.style.background='var(--surface-primary)'">
                        <div style="display: flex; align-items: center; margin-bottom: var(--space-sm);">
                            <i class="fas fa-handshake" style="color: var(--color-primary); margin-right: var(--space-sm); font-size: 1.125rem;"></i>
                            <strong style="color: var(--color-primary); font-size: 0.875rem;">Schedule Meeting</strong>
                        </div>
                        <p style="margin: 0; font-size: 0.8125rem; color: var(--color-gray-600); line-height: 1.4;">
                            Demo advisor consultation flow
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sample Report Preview -->
        <div style="background: var(--color-gray-50); padding: 2rem; border-radius: 8px; margin: 2rem 0;">
            <h4 style="margin: 0 0 1rem 0; text-align: center; color: var(--color-primary);">Sample Report Content</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                <div style="background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <strong style="color: var(--color-primary);"><i class="fas fa-chart-area" style="margin-right: 0.5rem;"></i>Portfolio Analysis</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--color-gray-600);">Detailed comparison of Conservative, Balanced, and Aggressive strategies with success probabilities</p>
                </div>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <strong style="color: var(--color-primary);"><i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i>Risk Assessment</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--color-gray-600);">Monte Carlo simulation results showing worst-case, median, and best-case scenarios</p>
                </div>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <strong style="color: var(--color-primary);"><i class="fas fa-route" style="margin-right: 0.5rem;"></i>Implementation Guide</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--color-gray-600);">Step-by-step roadmap for transitioning to optimal allocation strategy</p>
                </div>
                
                <div style="background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <strong style="color: var(--color-primary);"><i class="fas fa-users" style="margin-right: 0.5rem;"></i>Board Materials</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--color-gray-600);">Executive summary slides and technical appendix ready for board presentation</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Capture Overlay -->
    <div id="lead-capture" class="lead-capture-overlay" style="display: none;">
        <div class="lead-capture-modal">
            <!-- Client Generation Flow Selection -->
            <div id="flow-selection" style="text-align: center;">
                <div style="background: var(--color-primary); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-bottom: 1rem;">
                    <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>PROFESSIONAL ANALYSIS
                </div>
                <h3 style="margin: 0 0 0.5rem 0; color: var(--color-primary);">Choose Your Engagement Model</h3>
                <p style="margin: 0 0 1.5rem 0; color: var(--color-gray-600); font-size: 0.9375rem;">
                    Select how you'd like to receive your comprehensive endowment analysis
                </p>
                
                <!-- Engagement Options -->
                <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                    <div onclick="showDirectAccess()" style="border: 2px solid var(--color-gray-200); border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s ease; background: white;" onmouseover="this.style.borderColor='var(--color-primary)'; this.style.background='var(--color-gray-50)'" onmouseout="this.style.borderColor='var(--color-gray-200)'; this.style.background='white'">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <i class="fas fa-download" style="color: var(--color-primary); margin-right: 0.75rem; font-size: 1.25rem;"></i>
                            <strong style="color: var(--color-primary);">Instant Download</strong>
                        </div>
                        <p style="margin: 0; font-size: 0.875rem; color: var(--color-gray-600); text-align: left;">
                            Get immediate access to your PDF report. Perfect for self-service analysis and internal planning.
                        </p>
                    </div>
                    
                    <div onclick="showConsultationFlow()" style="border: 2px solid var(--color-gray-200); border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s ease; background: white;" onmouseover="this.style.borderColor='var(--color-accent)'; this.style.background='var(--color-gray-50)'" onmouseout="this.style.borderColor='var(--color-gray-200)'; this.style.background='white'">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <i class="fas fa-handshake" style="color: var(--color-accent); margin-right: 0.75rem; font-size: 1.25rem;"></i>
                            <strong style="color: var(--color-accent);">Expert Consultation</strong>
                        </div>
                        <p style="margin: 0; font-size: 0.875rem; color: var(--color-gray-600); text-align: left;">
                            Schedule a strategic review with our wealth management team. Includes personalized recommendations and implementation support.
                        </p>
                    </div>
                    
                    <div onclick="showEmailDelivery()" style="border: 2px solid var(--color-gray-200); border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s ease; background: white;" onmouseover="this.style.borderColor='var(--color-success)'; this.style.background='var(--color-gray-50)'" onmouseout="this.style.borderColor='var(--color-gray-200)'; this.style.background='white'">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <i class="fas fa-envelope" style="color: var(--color-success); margin-right: 0.75rem; font-size: 1.25rem;"></i>
                            <strong style="color: var(--color-success);">Email Delivery</strong>
                        </div>
                        <p style="margin: 0; font-size: 0.875rem; color: var(--color-gray-600); text-align: left;">
                            Have the report sent directly to your inbox with executive summary highlights and key recommendations.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Direct Access Form -->
            <div id="direct-access-form" style="display: none;">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <i class="fas fa-download" style="color: var(--color-primary); font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--color-primary);">Instant Download Access</h3>
                    <p style="margin: 0; color: var(--color-gray-600); font-size: 0.9375rem;">
                        Enter your details to immediately download your comprehensive analysis
                    </p>
                </div>
                
                <form hx-post="/download-report" hx-target="#download-result">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Your Name</label>
                        <input type="text" name="name" required class="form-input" placeholder="John Smith">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-envelope" style="margin-right: 0.5rem;"></i>Email Address</label>
                        <input type="email" name="email" required class="form-input" placeholder="john@organization.org">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-building" style="margin-right: 0.5rem;"></i>Organization</label>
                        <input type="text" name="organization" class="form-input" placeholder="Your Organization Name">
                    </div>
                    
                    <!-- Hidden fields -->
                    <input type="hidden" name="balance" value="{{ results.balance }}">
                    <input type="hidden" name="withdrawal" value="{{ results.calculation_details.annual_withdrawal }}">
                    <input type="hidden" name="portfolio" value="comprehensive">
                    <input type="hidden" name="years" value="{{ results.years }}">
                    <input type="hidden" name="delivery_method" value="instant_download">
                    
                    {% for key, portfolio_data in results.portfolios.items() %}
                    <input type="hidden" name="{{ key }}_success_rate" value="{{ portfolio_data.success_rate }}">
                    {% endfor %}
                    
                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-primary" style="flex: 1;" onclick="simulateReportDownload()">
                            <i class="fas fa-download" style="margin-right: 0.5rem;"></i>Download Report
                        </button>
                        <button type="button" onclick="showFlowSelection()" class="btn btn-secondary" style="flex: 1;">
                            <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i>Back
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Consultation Form -->
            <div id="consultation-form" style="display: none;">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <i class="fas fa-handshake" style="color: var(--color-accent); font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--color-accent);">Schedule Expert Consultation</h3>
                    <p style="margin: 0; color: var(--color-gray-600); font-size: 0.9375rem;">
                        Connect with our wealth management team for personalized guidance
                    </p>
                </div>
                
                <form hx-post="/download-report" hx-target="#download-result">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Your Name</label>
                        <input type="text" name="name" required class="form-input" placeholder="John Smith">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-envelope" style="margin-right: 0.5rem;"></i>Email Address</label>
                        <input type="email" name="email" required class="form-input" placeholder="john@organization.org">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-building" style="margin-right: 0.5rem;"></i>Organization</label>
                        <input type="text" name="organization" required class="form-input" placeholder="Your Organization Name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-phone" style="margin-right: 0.5rem;"></i>Phone Number</label>
                        <input type="tel" name="phone" class="form-input" placeholder="(555) 123-4567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-calendar" style="margin-right: 0.5rem;"></i>Preferred Meeting Time</label>
                        <select name="meeting_preference" class="form-select">
                            <option value="">Select preferred time</option>
                            <option value="morning">Morning (9-11 AM)</option>
                            <option value="afternoon">Afternoon (1-3 PM)</option>
                            <option value="evening">Evening (4-6 PM)</option>
                            <option value="flexible">Flexible</option>
                        </select>
                    </div>
                    
                    <!-- Hidden fields -->
                    <input type="hidden" name="balance" value="{{ results.balance }}">
                    <input type="hidden" name="withdrawal" value="{{ results.calculation_details.annual_withdrawal }}">
                    <input type="hidden" name="portfolio" value="comprehensive">
                    <input type="hidden" name="years" value="{{ results.years }}">
                    <input type="hidden" name="delivery_method" value="consultation">
                    
                    {% for key, portfolio_data in results.portfolios.items() %}
                    <input type="hidden" name="{{ key }}_success_rate" value="{{ portfolio_data.success_rate }}">
                    {% endfor %}
                    
                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; background: var(--color-accent);">
                            <i class="fas fa-calendar-plus" style="margin-right: 0.5rem;"></i>Schedule Consultation
                        </button>
                        <button type="button" onclick="showFlowSelection()" class="btn btn-secondary" style="flex: 1;">
                            <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i>Back
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Email Delivery Form -->
            <div id="email-delivery-form" style="display: none;">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <i class="fas fa-envelope" style="color: var(--color-success); font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--color-success);">Email Delivery</h3>
                    <p style="margin: 0; color: var(--color-gray-600); font-size: 0.9375rem;">
                        Receive your report via email with executive summary and next steps
                    </p>
                </div>
                
                <form hx-post="/download-report" hx-target="#download-result">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Your Name</label>
                        <input type="text" name="name" required class="form-input" placeholder="John Smith">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-envelope" style="margin-right: 0.5rem;"></i>Email Address</label>
                        <input type="email" name="email" required class="form-input" placeholder="john@organization.org">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-building" style="margin-right: 0.5rem;"></i>Organization</label>
                        <input type="text" name="organization" class="form-input" placeholder="Your Organization Name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-clock" style="margin-right: 0.5rem;"></i>Preferred Delivery Time</label>
                        <select name="delivery_timing" class="form-select">
                            <option value="immediate">Send immediately</option>
                            <option value="morning">Tomorrow morning</option>
                            <option value="afternoon">Tomorrow afternoon</option>
                            <option value="weekly">Weekly digest</option>
                        </select>
                    </div>
                    
                    <!-- Hidden fields -->
                    <input type="hidden" name="balance" value="{{ results.balance }}">
                    <input type="hidden" name="withdrawal" value="{{ results.calculation_details.annual_withdrawal }}">
                    <input type="hidden" name="portfolio" value="comprehensive">
                    <input type="hidden" name="years" value="{{ results.years }}">
                    <input type="hidden" name="delivery_method" value="email">
                    
                    {% for key, portfolio_data in results.portfolios.items() %}
                    <input type="hidden" name="{{ key }}_success_rate" value="{{ portfolio_data.success_rate }}">
                    {% endfor %}
                    
                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; background: var(--color-success);">
                            <i class="fas fa-paper-plane" style="margin-right: 0.5rem;"></i>Send Report
                        </button>
                        <button type="button" onclick="showFlowSelection()" class="btn btn-secondary" style="flex: 1;">
                            <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i>Back
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="download-result" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <script>
        function showLeadCapture() {
            document.getElementById('lead-capture').style.display = 'flex';
            document.body.classList.add('modal-open');
            showFlowSelection();
        }
        
        function showAdvisorConsultation() {
            document.getElementById('lead-capture').style.display = 'flex';
            document.body.classList.add('modal-open');
            // Skip flow selection and go directly to consultation
            showConsultationFlow();
        }
        
        function hideLeadCapture() {
            document.getElementById('lead-capture').style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        function showFlowSelection() {
            // Hide all forms
            document.getElementById('direct-access-form').style.display = 'none';
            document.getElementById('consultation-form').style.display = 'none';
            document.getElementById('email-delivery-form').style.display = 'none';
            // Show flow selection
            document.getElementById('flow-selection').style.display = 'block';
        }
        
        function showDirectAccess() {
            document.getElementById('flow-selection').style.display = 'none';
            document.getElementById('direct-access-form').style.display = 'block';
        }
        
        function showConsultationFlow() {
            document.getElementById('flow-selection').style.display = 'none';
            document.getElementById('consultation-form').style.display = 'block';
        }
        
        function showEmailDelivery() {
            document.getElementById('flow-selection').style.display = 'none';
            document.getElementById('email-delivery-form').style.display = 'block';
        }
        
        // Simulation functions for demo
        function simulateDownload() {
            showToast(
                'Instant Download Demo',
                'This would open the instant download form with name/email fields for immediate PDF access.',
                'fas fa-download',
                [
                    'Self-service nonprofits',
                    'Quick access workflows', 
                    'Lower-touch client relationships',
                    'Immediate PDF generation'
                ]
            );
        }
        
        function simulateConsultation() {
            showToast(
                'Consultation Scheduling Demo',
                'This would open the consultation scheduling form for high-value lead capture.',
                'fas fa-handshake',
                [
                    'Meeting time preferences',
                    'Phone number capture',
                    'Strategic session booking',
                    'High-value lead qualification'
                ]
            );
        }
        
        function simulateReportDownload() {
            showToast(
                'Professional PDF Generated',
                'Your comprehensive endowment analysis is ready for download.',
                'fas fa-file-pdf',
                [
                    'Complete Monte Carlo analysis',
                    'Board presentation materials',
                    'Implementation strategy',
                    'Risk assessment details'
                ]
            );
            
            // Simulate actual download
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = '/pdf-template';
                link.download = 'Endowment_Analysis_Professional_Report.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                hideLeadCapture();
            }, 1000);
        }
        
        // Close on outside click
        document.getElementById('lead-capture').addEventListener('click', function(e) {
            if (e.target === this) {
                hideLeadCapture();
            }
        });
        
        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Success Rate Chart
            const successCtx = document.getElementById('successRateChart').getContext('2d');
            new Chart(successCtx, {
                type: 'bar',
                data: {
                    labels: [{% for key, portfolio_data in results.portfolios.items() %}'{{ portfolio_data.portfolio.name }}'{% if not loop.last %},{% endif %}{% endfor %}],
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: [{% for key, portfolio_data in results.portfolios.items() %}{{ portfolio_data.success_rate * 100 }}{% if not loop.last %},{% endif %}{% endfor %}],
                        backgroundColor: [
                            {% for key, portfolio_data in results.portfolios.items() %}
                            {% if portfolio_data.success_rate >= 0.7 %}'#059669'
                            {% elif portfolio_data.success_rate >= 0.5 %}'#d69e2e'
                            {% else %}'#c53030'{% endif %}{% if not loop.last %},{% endif %}
                            {% endfor %}
                        ],
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            // Portfolio projection charts
            {% for key, portfolio_data in results.portfolios.items() %}
            const {{ key }}Ctx = document.getElementById('portfolio-{{ key }}-chart').getContext('2d');
            const {{ key }}Data = {{ portfolio_data.projection_data | safe }};
            
            new Chart({{ key }}Ctx, {
                type: 'line',
                data: {
                    labels: {{ key }}Data.labels,
                    datasets: [
                        {
                            label: '90th Percentile',
                            data: {{ key }}Data.datasets[0].data,
                            borderColor: '#059669',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'Median (50th)',
                            data: {{ key }}Data.datasets[1].data,
                            borderColor: '#1a2332',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            fill: false
                        },
                        {
                            label: '10th Percentile',
                            data: {{ key }}Data.datasets[2].data,
                            borderColor: '#d69e2e',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'line',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Balance ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
            {% endfor %}
        });
    </script>
{% endblock %}