{# 
  @template templates/partials/comprehensive_results.html
  @type partial
  @htmx true
#}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    
    <!-- Executive Summary Card -->
    <div class="card result-hero">
        <h2 style="margin-bottom: 1rem; color: var(--color-primary);">Endowment Sustainability Analysis</h2>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            {% for key, portfolio_data in results.portfolios.items() %}
            <div style="text-align: center; padding: 1rem; background: var(--color-gray-50); border-radius: 8px;">
                <div style="font-size: 0.8125rem; color: var(--color-gray-600); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em;">{{ portfolio_data.portfolio.name }}</div>
                <div class="success-rate {% if portfolio_data.success_rate >= 0.7 %}success-rate--high{% elif portfolio_data.success_rate >= 0.5 %}success-rate--medium{% else %}success-rate--low{% endif %}" style="font-size: 2rem;">
                    {{ (portfolio_data.success_rate * 100)|round(1) }}%
                </div>
                <div style="font-size: 0.75rem; color: var(--color-gray-600);">Success Rate</div>
            </div>
            {% endfor %}
        </div>
        
        <div style="background: var(--color-gray-100); padding: 1rem; border-radius: 8px; font-size: 0.9375rem; color: var(--color-gray-700);">
            <strong>${{ "{:,.0f}".format(results.calculation_details.starting_balance) }} endowment</strong> with 
            <strong>${{ "{:,.0f}".format(results.calculation_details.annual_withdrawal) }} annual withdrawal</strong> 
            over {{ results.years }} years
        </div>
    </div>

    <!-- Portfolio Comparison Charts -->
    <div class="card">
        <h3>Portfolio Value Projections Comparison</h3>
        <div style="position: relative; height: 500px;">
            <canvas id="comparisonChart"></canvas>
        </div>
        <p style="font-size: 0.875rem; color: var(--color-gray-600); margin-top: 0.5rem;">
            Median (50th percentile) projections for each investment strategy based on 5,000 Monte Carlo simulations.
        </p>
    </div>

    <!-- Individual Portfolio Analysis -->
    {% for key, portfolio_data in results.portfolios.items() %}
    <div class="card">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: var(--color-gray-100); color: var(--color-gray-600); border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                {% if key == 'conservative' %}
                <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                {% elif key == 'balanced' %}
                <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
                </svg>
                {% else %}
                <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                {% endif %}
            </div>
            <div>
                <h3 style="margin: 0;">{{ portfolio_data.portfolio.name }} Strategy</h3>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--color-gray-600);">
                    {{ portfolio_data.portfolio.description }}
                </p>
            </div>
            <div style="margin-left: auto; text-align: right;">
                <div class="success-rate {% if portfolio_data.success_rate >= 0.7 %}success-rate--high{% elif portfolio_data.success_rate >= 0.5 %}success-rate--medium{% else %}success-rate--low{% endif %}" style="font-size: 2.5rem;">
                    {{ (portfolio_data.success_rate * 100)|round(1) }}%
                </div>
                <div style="font-size: 0.75rem; color: var(--color-gray-600);">Success Rate</div>
            </div>
        </div>

        <!-- Portfolio Details Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="text-align: center; padding: 1rem; background: var(--color-gray-50); border-radius: 6px;">
                <div style="font-size: 0.75rem; color: var(--color-gray-600); margin-bottom: 0.25rem; text-transform: uppercase;">Expected Return</div>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--color-primary);">{{ "{:.1f}".format(portfolio_data.portfolio.expected_return * 100) }}%</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: var(--color-gray-50); border-radius: 6px;">
                <div style="font-size: 0.75rem; color: var(--color-gray-600); margin-bottom: 0.25rem; text-transform: uppercase;">Volatility</div>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--color-warning);">{{ "{:.1f}".format(portfolio_data.portfolio.std_deviation * 100) }}%</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: var(--color-gray-50); border-radius: 6px;">
                <div style="font-size: 0.75rem; color: var(--color-gray-600); margin-bottom: 0.25rem; text-transform: uppercase;">Median Final</div>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--color-success);">${{ "{:,.0f}".format(portfolio_data.median_final_balance) }}</div>
            </div>
        </div>

        <!-- Individual Portfolio Chart -->
        <div style="position: relative; height: 350px; margin-bottom: 1rem;">
            <canvas id="portfolio-{{ key }}-chart"></canvas>
        </div>

        <!-- Analysis -->
        <div style="background: #eff6ff; padding: 1.25rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
            {% if portfolio_data.success_rate >= 0.8 %}
            <div style="color: #1e40af; font-size: 0.875rem; line-height: 1.6;">
                <strong>Excellent Sustainability:</strong> This {{ portfolio_data.portfolio.name|lower }} approach shows very high confidence for maintaining your {{ results.years }}-year spending plan. The {{ "{:.0f}".format(portfolio_data.portfolio.stocks_percentage) }}% stock allocation provides strong growth potential while managing risk effectively.
            </div>
            {% elif portfolio_data.success_rate >= 0.7 %}
            <div style="color: #1e40af; font-size: 0.875rem; line-height: 1.6;">
                <strong>Good Sustainability:</strong> This {{ portfolio_data.portfolio.name|lower }} strategy offers solid confidence for your spending goals. The balanced {{ "{:.0f}".format(portfolio_data.portfolio.stocks_percentage) }}% stock allocation provides reasonable growth while maintaining stability.
            </div>
            {% elif portfolio_data.success_rate >= 0.5 %}
            <div style="color: #1e40af; font-size: 0.875rem; line-height: 1.6;">
                <strong>Moderate Risk:</strong> This {{ portfolio_data.portfolio.name|lower }} approach carries some uncertainty. Consider adjusting your withdrawal rate or investment timeline to improve sustainability.
            </div>
            {% else %}
            <div style="color: #1e40af; font-size: 0.875rem; line-height: 1.6;">
                <strong>High Risk:</strong> This {{ portfolio_data.portfolio.name|lower }} strategy shows significant sustainability challenges. We recommend reducing annual withdrawals or considering a more aggressive investment approach.
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    {% set ns = namespace(best_success_rate=0, best_portfolio_name='Balanced (70/30)', best_portfolio_key='balanced') %}
    {% for key, portfolio_data in results.portfolios.items() %}
        {% if portfolio_data.success_rate > ns.best_success_rate %}
            {% set ns.best_success_rate = portfolio_data.success_rate %}
            {% set ns.best_portfolio_name = portfolio_data.portfolio.name %}
            {% set ns.best_portfolio_key = key %}
        {% endif %}
    {% endfor %}

    <!-- Recommendation Card -->
    <div class="card" style="background: var(--color-gray-50); border: 2px solid var(--color-primary);">
        <h3 style="color: var(--color-primary);">Investment Strategy Recommendation</h3>
        
        <div style="display: flex; align-items: start; gap: 1rem;">
            <div style="background: var(--color-primary); color: white; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div>
                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary);">Recommended: {{ ns.best_portfolio_name }} Strategy</h4>
                <p style="margin: 0; color: var(--color-gray-700); line-height: 1.6;">
                    Based on your {{ results.years }}-year timeline and ${{ "{:,.0f}".format(results.calculation_details.annual_withdrawal) }} annual withdrawal, 
                    the {{ ns.best_portfolio_name|lower }} approach offers the highest success rate at {{ "{:.1f}".format(ns.best_success_rate * 100) }}%. 
                    This strategy balances growth potential with risk management for sustainable endowment spending.
                </p>
            </div>
        </div>
    </div>

    <!-- Web Report Access -->
    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color-light); text-align: center;">
        <div style="background: var(--surface-muted); border: 1px solid var(--border-color-light); padding: var(--space-xl); border-radius: var(--border-radius);">
            <h3 style="margin: 0 0 var(--space-sm) 0; color: var(--color-primary); font-weight: 600;">Generate Web Report</h3>
            <p style="margin: 0 0 var(--space-lg) 0; font-size: 0.875rem; color: var(--color-gray-600); line-height: 1.5;">
                Create a professional web version of this analysis that can be shared with clients, exported to PDF, or used for lead generation.
            </p>
            <a href="/report-preview" class="btn btn-primary" style="padding: var(--space-lg) var(--space-2xl); font-size: 1rem; text-decoration: none;">
                <i class="fas fa-globe" style="margin-right: 0.5rem;"></i>View Web Report
            </a>
            <div style="margin-top: var(--space-md); font-size: 0.8125rem; color: var(--color-gray-500);">
                <i class="fas fa-share-alt" style="margin-right: 0.25rem;"></i>Shareable link • 
                <i class="fas fa-download" style="margin-right: 0.25rem;"></i>PDF export • 
                <i class="fas fa-users" style="margin-right: 0.25rem;"></i>Lead capture
            </div>
        </div>
    </div>

</div>

<!-- Chart initialization script -->
<script>
// Global chart cleanup
window.nonprofitCharts = window.nonprofitCharts || {};

function cleanupCharts() {
    Object.keys(window.nonprofitCharts).forEach(key => {
        if (window.nonprofitCharts[key]) {
            window.nonprofitCharts[key].destroy();
            delete window.nonprofitCharts[key];
        }
    });
}

document.addEventListener('htmx:beforeSwap', function(evt) {
    if (evt.target.id === 'results') {
        cleanupCharts();
    }
});

cleanupCharts();

// Portfolio data
var portfolioData = {{ results.portfolios | tojson | safe }};
var portfolioKeys = {{ results.portfolios.keys() | list | tojson | safe }};

// Create comparison chart
var comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
var comparisonDatasets = [];

portfolioKeys.forEach(function(key, index) {
    var portfolio = portfolioData[key];
    var colors = {
        'conservative': '#059669',
        'balanced': '#1a2332', 
        'aggressive': '#2b6cb0'
    };
    
    // Parse projection_data if it's a string
    var projectionData = portfolio.projection_data;
    if (typeof projectionData === 'string') {
        projectionData = JSON.parse(projectionData);
    }
    
    comparisonDatasets.push({
        label: portfolio.portfolio.name,
        data: projectionData.datasets[1].data, // Median line
        borderColor: colors[key],
        backgroundColor: 'transparent',
        borderWidth: 3,
        pointRadius: 0,
        pointHoverRadius: 6,
        pointHoverBackgroundColor: colors[key],
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 2,
        tension: 0.1
    });
});

// Get labels from first portfolio's projection data
var firstPortfolioData = portfolioData[portfolioKeys[0]].projection_data;
if (typeof firstPortfolioData === 'string') {
    firstPortfolioData = JSON.parse(firstPortfolioData);
}

window.nonprofitCharts.comparisonChart = new Chart(comparisonCtx, {
    type: 'line',
    data: {
        labels: firstPortfolioData.labels,
        datasets: comparisonDatasets
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '$' + context.parsed.y.toLocaleString();
                        return label;
                    }
                }
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Years'
                }
            },
            y: {
                display: true,
                title: {
                    display: true,
                    text: 'Portfolio Value ($)'
                },
                ticks: {
                    callback: function(value) {
                        if (value >= 1000000) {
                            return '$' + (value / 1000000).toFixed(1) + 'M';
                        }
                        return '$' + (value / 1000).toFixed(0) + 'K';
                    }
                }
            }
        }
    }
});

// Create individual portfolio charts
portfolioKeys.forEach(function(key) {
    var portfolio = portfolioData[key];
    var ctx = document.getElementById('portfolio-' + key + '-chart').getContext('2d');
    
    var colors = {
        'conservative': '#059669',
        'balanced': '#1a2332', 
        'aggressive': '#2b6cb0'
    };
    
    // Parse projection_data if it's a string
    var projectionData = portfolio.projection_data;
    if (typeof projectionData === 'string') {
        projectionData = JSON.parse(projectionData);
    }
    
    window.nonprofitCharts['portfolio-' + key] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: projectionData.labels,
            datasets: [
                {
                    label: '90th Percentile',
                    data: projectionData.datasets[0].data,
                    borderColor: colors[key],
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                },
                {
                    label: 'Median (50th)',
                    data: projectionData.datasets[1].data,
                    borderColor: colors[key],
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.1
                },
                {
                    label: '10th Percentile',
                    data: projectionData.datasets[2].data,
                    borderColor: colors[key],
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += '$' + context.parsed.y.toLocaleString();
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Years'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Portfolio Value ($)'
                    },
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) {
                                return '$' + (value / 1000000).toFixed(1) + 'M';
                            }
                            return '$' + (value / 1000).toFixed(0) + 'K';
                        }
                    }
                }
            }
        }
    });
});
</script>


