{# 
  @template templates/partials/results_chartjs.html
  @type partial
  @htmx true
#}
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <!-- Primary Result Card -->
    <div class="card result-hero">
        <div class="success-rate {% if results.success_rate >= 0.7 %}success-rate--high{% elif results.success_rate >= 0.5 %}success-rate--medium{% else %}success-rate--low{% endif %}">
            {{ (results.success_rate * 100)|round(1) }}%
        </div>
        <div class="success-description">Probability of Success</div>
        <div style="font-size: 0.875rem; color: var(--color-gray-600); margin-top: 0.5rem;">
            {% if results.years == 100 %}
                Your endowment will last in perpetuity
            {% else %}
                Your endowment will last {{ results.years }} years
            {% endif %}
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Annual Withdrawal</div>
                <div class="metric-value">${{ "{:,.0f}".format(results.annual_withdrawal) }}</div>
                <div class="metric-subvalue">{{ "{:.1%}".format(results.withdrawal_rate) }} of initial</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Median Final Balance</div>
                <div class="metric-value">${{ "{:,.0f}".format(results.median_final_balance) }}</div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Overview -->
    <div class="card">
        <div style="display: flex; align-items: start; gap: 1rem;">
            <div style="background: var(--color-gray-100); color: var(--color-gray-600); border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <div>
                <h3>Your Endowment Sustainability Analysis</h3>
                <p style="margin: 0; color: var(--color-gray-700); line-height: 1.6; font-size: 0.9375rem;">
                    Based on your <strong>${{ "{:,.0f}".format(results.balance) }} endowment</strong> and <strong>${{ "{:,.0f}".format(results.annual_withdrawal) }} annual withdrawal</strong>, 
                    we've analyzed how your {{ results.portfolio.name|lower }} investment strategy would perform over {{ results.years }} years. 
                    {% if results.success_rate >= 0.8 %}
                        Your strategy shows <strong>excellent sustainability</strong> with very high confidence.
                    {% elif results.success_rate >= 0.7 %}
                        Your strategy shows <strong>good sustainability</strong> with solid confidence levels.
                    {% elif results.success_rate >= 0.5 %}
                        Your strategy shows <strong>moderate sustainability</strong> - consider adjustments for higher confidence.
                    {% else %}
                        Your strategy shows <strong>significant risk</strong> - we recommend reviewing your withdrawal rate or investment approach.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Calculation Breakdown -->
    <div class="card">
        <h3>Calculation Details</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <h4 style="font-size: 0.875rem; color: var(--color-gray-600); margin-bottom: 0.5rem;">Inputs</h4>
                <table style="width: 100%; font-size: 0.875rem;">
                    <tr>
                        <td style="padding: 0.25rem 0; color: var(--color-gray-600);">Starting Balance:</td>
                        <td style="text-align: right; font-weight: 500;">${{ "{:,.0f}".format(results.calculation_details.starting_balance) }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.25rem 0; color: var(--color-gray-600);">Annual Withdrawal:</td>
                        <td style="text-align: right; font-weight: 500;">${{ "{:,.0f}".format(results.calculation_details.annual_withdrawal) }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.25rem 0; color: var(--color-gray-600);">Withdrawal Rate:</td>
                        <td style="text-align: right; font-weight: 500;">{{ "{:.1f}".format(results.calculation_details.withdrawal_rate_percent) }}%</td>
                    </tr>
                </table>
            </div>
            <div>
                <h4 style="font-size: 0.875rem; color: var(--color-gray-600); margin-bottom: 0.5rem;">Portfolio Assumptions</h4>
                <table style="width: 100%; font-size: 0.875rem;">
                    <tr>
                        <td style="padding: 0.25rem 0; color: var(--color-gray-600);">Expected Return:</td>
                        <td style="text-align: right; font-weight: 500;">{{ "{:.1f}".format(results.calculation_details.expected_return_percent) }}%</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.25rem 0; color: var(--color-gray-600);">Inflation Rate:</td>
                        <td style="text-align: right; font-weight: 500;">{{ "{:.1f}".format(results.inflation_rate * 100) }}%</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.25rem 0; color: var(--color-gray-600);">Real Return:</td>
                        <td style="text-align: right; font-weight: 500; color: var(--color-success);">{{ "{:.1f}".format(results.calculation_details.real_return_percent) }}%</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--color-gray-50); border-radius: 4px; font-size: 0.875rem;">
            <strong>Total Withdrawals:</strong> ${{ "{:,.0f}".format(results.calculation_details.total_withdrawals) }} over {{ results.years }} years<br>
            <strong>Final Year Withdrawal:</strong> ${{ "{:,.0f}".format(results.calculation_details.inflation_adjusted_final_withdrawal) }}{% if results.adjust_for_inflation %} (inflation-adjusted){% else %} (fixed amount){% endif %}
        </div>
    </div>
    
    <!-- Portfolio Projection Chart -->
    <div class="card">
        <h3>Portfolio Value Projection</h3>
        <div style="position: relative; height: 400px;">
            <canvas id="projectionChart"></canvas>
        </div>
        <p style="font-size: 0.875rem; color: var(--color-gray-600); margin-top: 0.5rem;">
            This chart shows the range of possible outcomes based on 5,000 Monte Carlo simulations. The solid red line shows the median (50th percentile) outcome, while the dashed lines show the 10th and 90th percentile ranges.
        </p>
    </div>
    
    <!-- Income by Source Chart -->
    <div class="card">
        <h3>Annual Withdrawals vs Portfolio Value</h3>
        <div style="position: relative; height: 400px;">
            <canvas id="incomeChart"></canvas>
        </div>
        <p style="font-size: 0.875rem; color: var(--color-gray-600); margin-top: 0.5rem;">
            Blue area shows portfolio value (left axis). Green line shows annual withdrawals{% if results.adjust_for_inflation %} adjusted for inflation{% endif %} (right axis).
        </p>
    </div>
    
    <!-- Analysis section remains the same -->
    <div class="card">
        <h3>Analysis</h3>
        
        {% if results.success_rate >= 0.8 %}
        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
            <svg style="width: 20px; height: 20px; color: var(--color-success); margin-top: 3px; opacity: 0.8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <div style="font-weight: 500; color: #065f46;">High Success Rate</div>
                <p style="color: var(--color-gray-600);">This spending rate is very sustainable. Your organization has an excellent chance of maintaining this level of support {% if results.years == 100 %}in perpetuity{% else %}for {{ results.years }} years{% endif %}.</p>
            </div>
        </div>
        {% elif results.success_rate >= 0.7 %}
        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
            <svg style="width: 20px; height: 20px; color: var(--color-success); margin-top: 3px; opacity: 0.8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <div style="font-weight: 500; color: #065f46;">Good Success Rate</div>
                <p style="color: var(--color-gray-600);">This spending rate is reasonably sustainable. Your organization has a good chance of maintaining this level of support.</p>
            </div>
        </div>
        {% elif results.success_rate >= 0.5 %}
        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
            <svg style="width: 20px; height: 20px; color: var(--color-warning); margin-top: 3px; opacity: 0.8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
                <div style="font-weight: 500; color: #92400e;">Moderate Risk</div>
                <p style="color: var(--color-gray-600);">This spending rate carries moderate risk. Consider reducing spending or adjusting your portfolio to improve sustainability.</p>
            </div>
        </div>
        {% else %}
        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
            <svg style="width: 20px; height: 20px; color: var(--color-danger); margin-top: 3px; opacity: 0.8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <div style="font-weight: 500; color: #991b1b;">High Risk</div>
                <p style="color: var(--color-gray-600);">This spending rate is likely unsustainable. We strongly recommend reducing annual withdrawals or adopting a more aggressive investment strategy.</p>
            </div>
        </div>
        {% endif %}
        
        <div style="margin-top: 1rem; padding: 1.25rem; background: #eff6ff; border-radius: var(--border-radius); border-left: 4px solid #3b82f6;">
            <div style="font-size: 0.875rem; color: #1e40af; line-height: 1.6;">
                <strong>How We Calculated This:</strong><br>
                We ran <strong>5,000 Monte Carlo simulations</strong> to test your endowment strategy under thousands of different market scenarios. Each simulation models a complete {{ results.years }}-year period using:
                <ul style="margin: 0.75rem 0; padding-left: 1.5rem;">
                    <li><strong>{{ results.portfolio.name }}</strong> portfolio allocation</li>
                    <li>Historical market volatility patterns</li>
                    <li>{{ "{:.1%}".format(results.inflation_rate) }} annual inflation adjustment{% if not results.adjust_for_inflation %} (portfolio growth only){% endif %}</li>
                    <li>1% annual management fees</li>
                </ul>
                The <strong>{{ "{:.1%}".format(results.success_rate) }} success rate</strong> means {{ (results.success_rate * 100)|round(0)|int }} out of 100 similar nonprofits would successfully maintain their spending for the full {{ results.years }}-year period.
            </div>
        </div>
    </div>
    
    <!-- Analysis Tools Section -->
    <div class="card" style="margin-top: 1.5rem;">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
            <div>
                <h4 style="margin: 0; color: var(--color-gray-700);">Portfolio Analysis</h4>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--color-gray-600); line-height: 1.4;">
                    Compare success rates across Conservative, Balanced, and Aggressive strategies
                </p>
            </div>
            <button hx-post="/compare" 
                    hx-target="#comparison-results"
                    hx-vals='js:{"balance": document.querySelector("[name=balance]").value, "withdrawal": (document.querySelector("[name=withdrawal_method]").value === "percentage" ? document.querySelector("[name=balance]").value * (document.querySelector("[name=withdrawal_rate]").value / 100) : document.querySelector("[name=withdrawal_amount]").value), "withdrawal_method": document.querySelector("[name=withdrawal_method]").value, "years": document.querySelector("[name=years]:checked").value, "inflation": document.querySelector("[name=inflation]").value}'
                    class="btn btn-secondary" style="flex-shrink: 0; font-size: 0.8125rem;">
                Compare All Portfolios
            </button>
        </div>
    </div>
    
    <!-- Comparison Results Display - Right under Portfolio Analysis -->
    <div id="comparison-results"></div>
    
    <!-- Review Report Button - At the bottom -->
    <div style="text-align: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color-light);">
        <a href="/report-preview" 
           class="btn btn-primary" style="padding: var(--space-lg) var(--space-2xl); text-decoration: none; display: inline-block;">
            Review Professional Report
        </a>
        <p style="margin: var(--space-sm) 0 0 0; font-size: 0.8125rem; color: var(--color-gray-600);">
            Preview and download your detailed PDF analysis
        </p>
    </div>
</div>

<!-- Chart initialization script -->
<script>
// Global chart instances to manage cleanup
window.nonprofitCharts = window.nonprofitCharts || {};

// Clean up existing charts before creating new ones
function cleanupCharts() {
    Object.keys(window.nonprofitCharts).forEach(key => {
        if (window.nonprofitCharts[key]) {
            window.nonprofitCharts[key].destroy();
            delete window.nonprofitCharts[key];
        }
    });
}

// Clean up on HTMX swap
document.addEventListener('htmx:beforeSwap', function(evt) {
    if (evt.target.id === 'results') {
        cleanupCharts();
    }
});

// Initialize charts
cleanupCharts(); // Clean up any existing charts first

// Parse the projection data
var projectionData = {{ results.projection_data | safe }};

// Create projection chart
var projectionCtx = document.getElementById('projectionChart').getContext('2d');
window.nonprofitCharts.projectionChart = new Chart(projectionCtx, {
    type: 'line',
    data: {
        labels: projectionData.labels,
        datasets: [
            {
                label: '90th Percentile',
                data: projectionData.datasets[0].data,
                borderColor: '#059669',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#059669',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2,
                tension: 0.1
            },
            {
                label: 'Median (50th Percentile)',
                data: projectionData.datasets[1].data,
                borderColor: '#1a2332',
                backgroundColor: 'transparent',
                borderWidth: 3,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#1a2332',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2,
                tension: 0.1
            },
            {
                label: '10th Percentile',
                data: projectionData.datasets[2].data,
                borderColor: '#2b6cb0',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#2b6cb0',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2,
                tension: 0.1
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '$' + context.parsed.y.toLocaleString();
                        return label;
                    }
                }
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Years'
                }
            },
            y: {
                display: true,
                title: {
                    display: true,
                    text: 'Portfolio Value ($)'
                },
                ticks: {
                    callback: function(value) {
                        if (value >= 1000000) {
                            return '$' + (value / 1000000).toFixed(1) + 'M';
                        }
                        return '$' + (value / 1000).toFixed(0) + 'K';
                    }
                }
            }
        }
    }
});

// Create income chart
var incomeCtx = document.getElementById('incomeChart').getContext('2d');

// Generate income chart data
var incomeYears = {{ results.years }};
var incomeWithdrawal = {{ results.annual_withdrawal }};
var incomeInflationRate = {{ results.inflation_rate }};
var incomeExpectedReturn = {{ results.calculation_details.expected_return_percent / 100 }};
var incomeBalance = {{ results.balance }};
var adjustForInflation = {{ results.adjust_for_inflation|lower }};

var incomeLabels = [];
var withdrawalData = [];
var balanceData = [];

for (var year = 0; year <= incomeYears; year++) {
    incomeLabels.push(year);
    
    // Calculate withdrawal based on method (matching Monte Carlo logic)  
    // Year 0: No withdrawal (starting point)
    // For percentage method: Adjust for inflation
    // For fixed amount method: Keep withdrawal constant
    var adjustedWithdrawal;
    if (year === 0) {
        adjustedWithdrawal = 0;
    } else if (adjustForInflation) {
        // Percentage method: withdrawal grows with inflation
        adjustedWithdrawal = incomeWithdrawal * Math.pow(1 + incomeInflationRate, year - 1);
    } else {
        // Fixed amount method: withdrawal stays constant
        adjustedWithdrawal = incomeWithdrawal;
    }
    withdrawalData.push(adjustedWithdrawal);
    
    // Calculate balance after return and withdrawal (matching Monte Carlo)
    if (year > 0) {
        // Apply expected return and subtract management fee (1%), then subtract withdrawal
        var managementFee = 0.01;
        incomeBalance = incomeBalance * (1 + incomeExpectedReturn - managementFee) - adjustedWithdrawal;
        if (incomeBalance < 0) incomeBalance = 0;
    }
    balanceData.push(incomeBalance);
}

// Calculate scale factors for better chart readability
var maxWithdrawal = Math.max(...withdrawalData);
var maxBalance = Math.max(...balanceData);

window.nonprofitCharts.incomeChart = new Chart(incomeCtx, {
    type: 'line',
    data: {
        labels: incomeLabels,
        datasets: [
            {
                label: 'Portfolio Value',
                data: balanceData,
                borderColor: '#2b6cb0',
                backgroundColor: 'rgba(43, 108, 176, 0.1)',
                borderWidth: 3,
                fill: true,
                order: 2,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#2b6cb0',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2,
                yAxisID: 'y',
                tension: 0.1
            },
            {
                label: 'Annual Withdrawal',
                data: withdrawalData,
                borderColor: '#059669',
                backgroundColor: 'rgba(5, 150, 105, 0.8)',
                borderWidth: adjustForInflation ? 3 : 4,
                fill: false,
                order: 1,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#059669',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2,
                yAxisID: 'y1',
                tension: adjustForInflation ? 0.1 : 0
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            legend: {
                position: 'top',
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#ddd',
                borderWidth: 1,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 13
                },
                padding: 10,
                callbacks: {
                    title: function(tooltipItems) {
                        return 'Year ' + tooltipItems[0].label;
                    },
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        const value = context.parsed.y;
                        if (value >= 1000000) {
                            label += '$' + (value / 1000000).toFixed(2) + 'M';
                        } else if (value >= 1000) {
                            label += '$' + (value / 1000).toFixed(0) + 'K';
                        } else {
                            label += '$' + value.toLocaleString();
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Years'
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Portfolio Value ($)',
                    color: '#2b6cb0'
                },
                ticks: {
                    color: '#2b6cb0',
                    callback: function(value) {
                        if (value >= 1000000) {
                            return '$' + (value / 1000000).toFixed(1) + 'M';
                        }
                        return '$' + (value / 1000).toFixed(0) + 'K';
                    }
                },
                grid: {
                    drawOnChartArea: true,
                    color: 'rgba(43, 108, 176, 0.1)'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Annual Withdrawal ($)',
                    color: '#059669'
                },
                min: 0,
                max: maxWithdrawal * 1.2,
                ticks: {
                    color: '#059669',
                    stepSize: adjustForInflation ? undefined : maxWithdrawal / 4,
                    callback: function(value) {
                        if (value >= 1000) {
                            return '$' + (value / 1000).toFixed(0) + 'K';
                        } else {
                            return '$' + value.toFixed(0);
                        }
                    }
                },
                grid: {
                    drawOnChartArea: false
                }
            }
        }
    }
});
</script>

<!-- Professional Report Modal -->
<div id="download-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 500px;">
        <h3>Professional Report Preview</h3>
        <p style="margin: 0.5rem 0 1.5rem 0; font-size: 0.9375rem; color: var(--color-gray-600);">
            Your comprehensive endowment sustainability analysis
        </p>
        
        <!-- Report Summary -->
        <div style="background: var(--color-gray-50); padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span style="color: var(--color-gray-600); font-size: 0.875rem;">Success Rate:</span>
                <span style="font-weight: 600; color: var(--color-primary);">{{ (results.success_rate * 100)|round(1) }}%</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span style="color: var(--color-gray-600); font-size: 0.875rem;">Portfolio:</span>
                <span style="font-weight: 600;">{{ results.portfolio.name }}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-gray-600); font-size: 0.875rem;">Time Horizon:</span>
                <span style="font-weight: 600;">{{ results.years }} years</span>
            </div>
        </div>
        
        <!-- Download Form -->
        <div id="download-form" style="display: none;">
            <form hx-post="/download-report" hx-target="#download-result">
                <div class="form-group">
                    <label class="form-label">Your Name</label>
                    <input type="text" name="name" required
                           class="form-input"
                           placeholder="John Smith">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" name="email" required
                           class="form-input"
                           placeholder="john@organization.org">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Organization</label>
                    <input type="text" name="organization"
                           class="form-input"
                           placeholder="Your Organization Name">
                </div>
                
                <!-- Hidden fields with results -->
                <input type="hidden" name="balance" value="{{ results.balance }}">
                <input type="hidden" name="withdrawal" value="{{ results.annual_withdrawal }}">
                <input type="hidden" name="portfolio" value="{{ results.portfolio.name }}">
                <input type="hidden" name="years" value="{{ results.years }}">
                <input type="hidden" name="success_rate" value="{{ results.success_rate }}">
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        Send Report
                    </button>
                    <button type="button" 
                            onclick="document.getElementById('download-form').style.display='none'; document.getElementById('download-buttons').style.display='flex';"
                            class="btn btn-secondary" style="flex: 1;">
                        Back
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Action Buttons -->
        <div id="download-buttons" style="display: flex; gap: 0.75rem;">
            <button onclick="document.getElementById('download-form').style.display='block'; document.getElementById('download-buttons').style.display='none';" 
                    class="btn btn-primary" style="flex: 1;">
                Download PDF
            </button>
            <button type="button" 
                    onclick="document.getElementById('download-modal').classList.add('hidden')"
                    class="btn btn-secondary" style="flex: 1;">
                Close
            </button>
        </div>
        
        <div id="download-result" style="margin-top: 1rem;"></div>
    </div>
</div>