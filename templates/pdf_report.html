<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endowment Sustainability Analysis</title>
    
    <!-- Chart.js for PDF charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        /* Letter size dimensions (216mm x 279mm = 816px x 1054px) */
        :root {
            --page-width: 216mm;
            --page-height: 279mm;
            --page-margin: 20mm;
            --content-width: calc(216mm - 40mm);
            --content-height: calc(279mm - 40mm);
            
            /* Zenith colors */
            --color-primary: #1a2332;
            --color-accent: #2b6cb0;
            --color-success: #059669;
            --color-warning: #d69e2e;
            --color-danger: #c53030;
            --color-gray-50: #f9fafb;
            --color-gray-600: #4a5568;
            --color-gray-700: #2d3748;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: #2d3748;
            background: white;
        }
        
        /* Page structure - exactly like Reactive Resume */
        .page {
            width: var(--page-width);
            min-height: var(--page-height);
            padding: var(--page-margin);
            page-break-after: always;
            position: relative;
            background: white;
        }
        
        .page:last-child {
            page-break-after: avoid;
        }
        
        /* Header styles */
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 20px;
        }
        
        .report-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 8px;
        }
        
        .report-subtitle {
            font-size: 14px;
            color: var(--color-gray-600);
            margin-bottom: 4px;
        }
        
        .report-date {
            font-size: 11px;
            color: var(--color-gray-600);
        }
        
        /* Executive summary */
        .executive-summary {
            background: var(--color-gray-50);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid var(--color-primary);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-item {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .summary-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--color-gray-600);
            margin-bottom: 4px;
            letter-spacing: 0.05em;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--color-primary);
        }
        
        .success-rate-high { color: var(--color-success); }
        .success-rate-medium { color: var(--color-warning); }
        .success-rate-low { color: var(--color-danger); }
        
        /* Section styles */
        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 12px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        /* Chart container */
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 15px 0;
            page-break-inside: avoid;
        }
        
        .chart-large {
            height: 400px;
        }
        
        /* Portfolio analysis grid */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        
        .portfolio-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        
        .portfolio-name {
            font-size: 14px;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 8px;
        }
        
        .portfolio-metrics {
            font-size: 11px;
            color: var(--color-gray-600);
        }
        
        .portfolio-success-rate {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 8px 0;
        }
        
        /* Recommendation box */
        .recommendation {
            background: #eff6ff;
            border: 2px solid var(--color-accent);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .recommendation-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--color-accent);
            margin-bottom: 8px;
        }
        
        /* Footer */
        .page-footer {
            position: absolute;
            bottom: var(--page-margin);
            left: var(--page-margin);
            right: var(--page-margin);
            text-align: center;
            font-size: 10px;
            color: var(--color-gray-600);
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
        }
        
        /* Page numbers */
        .page-number {
            position: absolute;
            bottom: 10mm;
            right: var(--page-margin);
            font-size: 10px;
            color: var(--color-gray-600);
        }
        
        /* Calculation details table */
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 11px;
        }
        
        .details-table th,
        .details-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .details-table th {
            background: var(--color-gray-50);
            font-weight: bold;
            color: var(--color-primary);
        }
        
        .details-table .number {
            text-align: right;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Page 1: Executive Summary & Overview -->
    <div class="page" data-page="1">
        <div class="report-header">
            <div class="report-title">Endowment Sustainability Analysis</div>
            <div class="report-subtitle">Comprehensive Investment Strategy Report</div>
            <div class="report-date">Generated on {{ current_date }}</div>
        </div>
        
        <div class="executive-summary">
            <h3 style="color: var(--color-primary); margin-bottom: 10px;">Executive Summary</h3>
            <p style="margin-bottom: 15px;">
                Analysis of a <strong>${{ "{:,.0f}".format(results.balance) }} endowment</strong> with 
                <strong>${{ "{:,.0f}".format(results.calculation_details.annual_withdrawal) }} annual withdrawals</strong> 
                over a {{ results.years }}-year investment horizon.
            </p>
            
            <div class="summary-grid">
                {% for key, portfolio_data in results.portfolios.items() %}
                <div class="summary-item">
                    <div class="summary-label">{{ portfolio_data.portfolio.name }}</div>
                    <div class="summary-value {% if portfolio_data.success_rate >= 0.7 %}success-rate-high{% elif portfolio_data.success_rate >= 0.5 %}success-rate-medium{% else %}success-rate-low{% endif %}">
                        {{ "{:.1f}".format(portfolio_data.success_rate * 100) }}%
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="section">
            <h3 class="section-title">Portfolio Comparison Overview</h3>
            <div class="chart-container chart-large">
                <canvas id="comparisonChart"></canvas>
            </div>
            <p style="font-size: 10px; color: var(--color-gray-600); text-align: center; margin-top: 8px;">
                Median portfolio value projections for each investment strategy over {{ results.years }} years
            </p>
        </div>
        
        <div class="recommendation">
            {% set ns = namespace(best_success_rate=0, best_portfolio_name='Balanced (70/30)', best_portfolio_key='balanced') %}
            {% for key, portfolio_data in results.portfolios.items() %}
                {% if portfolio_data.success_rate > ns.best_success_rate %}
                    {% set ns.best_success_rate = portfolio_data.success_rate %}
                    {% set ns.best_portfolio_name = portfolio_data.portfolio.name %}
                    {% set ns.best_portfolio_key = key %}
                {% endif %}
            {% endfor %}
            
            <div class="recommendation-title">Recommended Strategy: {{ ns.best_portfolio_name }}</div>
            <p>
                Based on your {{ results.years }}-year timeline and withdrawal requirements, 
                the {{ ns.best_portfolio_name|lower }} approach offers the highest success rate at 
                <strong>{{ "{:.1f}".format(ns.best_success_rate * 100) }}%</strong>. 
                This strategy provides the optimal balance of growth potential and risk management 
                for sustainable endowment spending.
            </p>
        </div>
        
        <div class="page-footer">
            <strong>Powered by Zenith Wealth Partners</strong> | Professional Endowment Analysis
        </div>
        <div class="page-number">Page 1 of 3</div>
    </div>
    
    <!-- Page 2: Individual Portfolio Analysis -->
    <div class="page" data-page="2">
        <div class="section">
            <h3 class="section-title">Individual Portfolio Analysis</h3>
            
            {% for key, portfolio_data in results.portfolios.items() %}
            <div class="section" style="margin-bottom: 30px;">
                <h4 style="color: var(--color-primary); font-size: 14px; margin-bottom: 10px;">
                    {{ portfolio_data.portfolio.name }} Strategy
                </h4>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div>
                        <div class="chart-container">
                            <canvas id="portfolio-{{ key }}-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="portfolio-card">
                            <div class="portfolio-success-rate {% if portfolio_data.success_rate >= 0.7 %}success-rate-high{% elif portfolio_data.success_rate >= 0.5 %}success-rate-medium{% else %}success-rate-low{% endif %}">
                                {{ "{:.1f}".format(portfolio_data.success_rate * 100) }}%
                            </div>
                            <div style="text-align: center; font-size: 10px; color: var(--color-gray-600); margin-bottom: 10px;">Success Rate</div>
                            
                            <table style="width: 100%; font-size: 10px;">
                                <tr>
                                    <td>Expected Return:</td>
                                    <td class="number">{{ "{:.1f}".format(portfolio_data.portfolio.expected_return * 100) }}%</td>
                                </tr>
                                <tr>
                                    <td>Volatility:</td>
                                    <td class="number">{{ "{:.1f}".format(portfolio_data.portfolio.std_deviation * 100) }}%</td>
                                </tr>
                                <tr>
                                    <td>Median Final:</td>
                                    <td class="number">${{ "{:,.0f}".format(portfolio_data.median_final_balance) }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 11px;">
                    <strong>Analysis:</strong>
                    {% if portfolio_data.success_rate >= 0.8 %}
                    This {{ portfolio_data.portfolio.name|lower }} approach shows excellent sustainability with very high confidence for maintaining your spending plan.
                    {% elif portfolio_data.success_rate >= 0.7 %}
                    This {{ portfolio_data.portfolio.name|lower }} strategy offers solid confidence for your spending goals with reasonable growth.
                    {% elif portfolio_data.success_rate >= 0.5 %}
                    This {{ portfolio_data.portfolio.name|lower }} approach carries moderate risk. Consider adjustments for higher confidence.
                    {% else %}
                    This {{ portfolio_data.portfolio.name|lower }} strategy shows significant sustainability challenges and may require reducing withdrawals.
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="page-footer">
            <strong>Powered by Zenith Wealth Partners</strong> | Professional Endowment Analysis
        </div>
        <div class="page-number">Page 2 of 3</div>
    </div>
    
    <!-- Page 3: Technical Details & Methodology -->
    <div class="page" data-page="3">
        <div class="section">
            <h3 class="section-title">Calculation Details</h3>
            
            <table class="details-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Starting Balance</td>
                        <td class="number">${{ "{:,.0f}".format(results.calculation_details.starting_balance) }}</td>
                        <td>Initial endowment value</td>
                    </tr>
                    <tr>
                        <td>Annual Withdrawal</td>
                        <td class="number">${{ "{:,.0f}".format(results.calculation_details.annual_withdrawal) }}</td>
                        <td>{{ "{:.1f}".format(results.calculation_details.withdrawal_rate_percent) }}% of initial balance</td>
                    </tr>
                    <tr>
                        <td>Time Horizon</td>
                        <td class="number">{{ results.years }} years</td>
                        <td>Investment planning period</td>
                    </tr>
                    <tr>
                        <td>Inflation Rate</td>
                        <td class="number">{{ "{:.1f}".format(results.inflation_rate * 100) }}%</td>
                        <td>Annual inflation assumption</td>
                    </tr>
                    <tr>
                        <td>Total Withdrawals</td>
                        <td class="number">${{ "{:,.0f}".format(results.calculation_details.total_withdrawals) }}</td>
                        <td>Cumulative over {{ results.years }} years</td>
                    </tr>
                    <tr>
                        <td>Final Year Withdrawal</td>
                        <td class="number">${{ "{:,.0f}".format(results.calculation_details.inflation_adjusted_final_withdrawal) }}</td>
                        <td>{% if results.adjust_for_inflation %}Inflation-adjusted{% else %}Fixed amount{% endif %}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h3 class="section-title">Methodology</h3>
            <div style="background: #eff6ff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--color-accent);">
                <h4 style="color: var(--color-accent); margin-bottom: 8px;">Monte Carlo Simulation</h4>
                <p style="margin-bottom: 10px;">
                    This analysis employs <strong>5,000 Monte Carlo simulations</strong> to model potential outcomes 
                    for your endowment over the {{ results.years }}-year period. Each simulation uses:
                </p>
                <ul style="margin-left: 20px; margin-bottom: 10px;">
                    <li>Historical market volatility patterns</li>
                    <li>Portfolio-specific expected returns and standard deviations</li>
                    <li>{{ "{:.1%}".format(results.inflation_rate) }} annual inflation adjustment</li>
                    <li>1% annual management fees</li>
                </ul>
                <p>
                    The success rate represents the percentage of scenarios where your endowment successfully 
                    maintains the required withdrawals for the full time period without depletion.
                </p>
            </div>
        </div>
        
        <div class="section">
            <h3 class="section-title">Risk Considerations</h3>
            <div style="font-size: 11px; line-height: 1.5;">
                <p style="margin-bottom: 8px;">
                    <strong>Market Risk:</strong> Past performance does not guarantee future results. 
                    Market conditions can vary significantly from historical patterns.
                </p>
                <p style="margin-bottom: 8px;">
                    <strong>Inflation Risk:</strong> Actual inflation may differ from the {{ "{:.1%}".format(results.inflation_rate) }} 
                    assumption used in this analysis.
                </p>
                <p style="margin-bottom: 8px;">
                    <strong>Model Limitations:</strong> Monte Carlo simulations provide probabilistic estimates 
                    based on historical data and may not capture all potential market scenarios.
                </p>
            </div>
        </div>
        
        <div class="section">
            <h3 class="section-title">Next Steps</h3>
            <div style="background: var(--color-gray-50); padding: 15px; border-radius: 8px;">
                <ol style="margin-left: 20px; font-size: 11px; line-height: 1.6;">
                    <li>Review the recommended investment strategy with your board</li>
                    <li>Consider your organization's risk tolerance and mission requirements</li>
                    <li>Consult with qualified investment professionals for implementation</li>
                    <li>Establish regular monitoring and rebalancing procedures</li>
                    <li>Review and update projections annually or when circumstances change</li>
                </ol>
            </div>
        </div>
        
        <div class="page-footer">
            <strong>Powered by Zenith Wealth Partners</strong> | Professional Endowment Analysis
        </div>
        <div class="page-number">Page 3 of 3</div>
    </div>

    <!-- Chart initialization script -->
    <script>
        // Portfolio data
        var portfolioData = {{ results.portfolios | tojson | safe }};
        var portfolioKeys = {{ results.portfolios.keys() | list | tojson | safe }};

        // Create comparison chart (Page 1)
        var comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
        var comparisonDatasets = [];

        portfolioKeys.forEach(function(key, index) {
            var portfolio = portfolioData[key];
            var colors = {
                'conservative': '#059669',
                'balanced': '#1a2332', 
                'aggressive': '#2b6cb0'
            };
            
            var projectionData = portfolio.projection_data;
            if (typeof projectionData === 'string') {
                projectionData = JSON.parse(projectionData);
            }
            
            comparisonDatasets.push({
                label: portfolio.portfolio.name,
                data: projectionData.datasets[1].data,
                borderColor: colors[key],
                backgroundColor: 'transparent',
                borderWidth: 2.5,
                pointRadius: 0,
                tension: 0.1
            });
        });

        var firstPortfolioData = portfolioData[portfolioKeys[0]].projection_data;
        if (typeof firstPortfolioData === 'string') {
            firstPortfolioData = JSON.parse(firstPortfolioData);
        }

        new Chart(comparisonCtx, {
            type: 'line',
            data: {
                labels: firstPortfolioData.labels,
                datasets: comparisonDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Years' } },
                    y: {
                        title: { display: true, text: 'Portfolio Value ($)' },
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });

        // Create individual portfolio charts (Page 2)
        portfolioKeys.forEach(function(key) {
            var portfolio = portfolioData[key];
            var ctx = document.getElementById('portfolio-' + key + '-chart').getContext('2d');
            
            var colors = {
                'conservative': '#059669',
                'balanced': '#1a2332', 
                'aggressive': '#2b6cb0'
            };
            
            var projectionData = portfolio.projection_data;
            if (typeof projectionData === 'string') {
                projectionData = JSON.parse(projectionData);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: projectionData.labels,
                    datasets: [
                        {
                            label: '90th Percentile',
                            data: projectionData.datasets[0].data,
                            borderColor: colors[key],
                            backgroundColor: 'transparent',
                            borderDash: [3, 3],
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Median (50th)',
                            data: projectionData.datasets[1].data,
                            borderColor: colors[key],
                            backgroundColor: 'transparent',
                            borderWidth: 2.5,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: '10th Percentile',
                            data: projectionData.datasets[2].data,
                            borderColor: colors[key],
                            backgroundColor: 'transparent',
                            borderDash: [3, 3],
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Years' } },
                        y: {
                            title: { display: true, text: 'Portfolio Value ($)' },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        });

        // Wait for charts to render, then trigger print
        setTimeout(function() {
            window.isPrintReady = true;
        }, 2000);
    </script>
</body>
</html>